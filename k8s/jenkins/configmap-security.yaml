apiVersion: v1
kind: ConfigMap
metadata:
  name: jenkins-security-config
  namespace: jenkins
data:
  01-security.groovy: |
    import hudson.security.FullControlOnceLoggedInAuthorizationStrategy
    import hudson.security.HudsonPrivateSecurityRealm
    import jenkins.model.Jenkins

    Jenkins instance = Jenkins.get()

    String adminUser = System.getenv("JENKINS_ADMIN_USER") ?: "ci-admin"
    String adminPassword = System.getenv("JENKINS_ADMIN_PASSWORD") ?: ""

    if (!adminPassword) {
        throw new IllegalStateException("JENKINS_ADMIN_PASSWORD environment variable must be provided")
    }

    HudsonPrivateSecurityRealm realm = instance.getSecurityRealm() instanceof HudsonPrivateSecurityRealm
        ? (HudsonPrivateSecurityRealm) instance.getSecurityRealm()
        : new HudsonPrivateSecurityRealm(false)

    if (realm.getUser(adminUser) == null) {
        realm.createAccount(adminUser, adminPassword)
    } else {
        println "Admin user '${adminUser}' already exists; leave existing password untouched."
    }
    instance.setSecurityRealm(realm)

    FullControlOnceLoggedInAuthorizationStrategy strategy = new FullControlOnceLoggedInAuthorizationStrategy()
    strategy.setAllowAnonymousRead(false)
    instance.setAuthorizationStrategy(strategy)

    instance.save()
  02-kubernetes-cloud.groovy: |
    import jenkins.model.Jenkins

    try {
        def instance = Jenkins.get()
        def cloudName = 'kubernetes'

        if (instance.clouds.getByName(cloudName) == null) {
            if (instance.pluginManager.getPlugin('kubernetes') == null) {
                println "Kubernetes plugin not installed; skipping cloud configuration"
                return
            }

            def serverUrl = 'https://kubernetes.default.svc.cluster.local'
            def namespace = System.getenv('POD_NAMESPACE') ?: 'jenkins'
            def jenkinsServiceHost = System.getenv('JENKINS_SERVICE_HOST') ?: 'jenkins'
            def jenkinsHttpPort = System.getenv('JENKINS_SERVICE_PORT_HTTP') ?: '80'
            def jenkinsAgentPort = System.getenv('JENKINS_SERVICE_PORT_AGENT') ?: '50000'
            def jenkinsUrl = "http://${jenkinsServiceHost}.${namespace}.svc.cluster.local:${jenkinsHttpPort}"
            def jenkinsTunnel = "${jenkinsServiceHost}.${namespace}.svc.cluster.local:${jenkinsAgentPort}"

            def cloud = new org.csanchez.jenkins.plugins.kubernetes.KubernetesCloud(cloudName)
            cloud.setServerUrl(serverUrl)
            cloud.setNamespace(namespace)
            cloud.setSkipTlsVerify(true)
            cloud.setJenkinsUrl(jenkinsUrl)
            cloud.setJenkinsTunnel(jenkinsTunnel)
            cloud.setContainerCapStr('10')

            instance.clouds.add(cloud)
            instance.save()
            println "Configured Kubernetes cloud '${cloudName}' for namespace '${namespace}'"
        } else {
            println "Kubernetes cloud '${cloudName}' already configured"
        }
    } catch (Throwable t) {
        println "Failed to configure Kubernetes cloud: ${t.message}"
        t.printStackTrace()
    }
